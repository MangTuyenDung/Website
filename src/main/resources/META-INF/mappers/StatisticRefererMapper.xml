<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hadoopvietnam.persistence.repositories.statistics.StatisticRefererRepository">

    <cache type="org.mybatis.caches.ehcache.EhcacheCache"/>
    
    <select id="findBy" resultType="StatisticRefererDomain" flushCache="false" useCache="true">
        SELECT 
        ref_id as id, 
        referal, 
        DOMAIN, 
        KEYWORD, 
        COUNT, 
        tstamp as created 
        FROM nstatistics_refer
        WHERE
        referal like #{referer}
        AND (
        DATE_FORMAT( tstamp, '%m-%d-%Y %H:%i:%s') = DATE_FORMAT( 
        CURRENT_TIMESTAMP, '%m-%d-%Y %H:%i:%s')
        )
    </select>
    
    <insert id="save" parameterType="StatisticRefererDomain" flushCache="true">
        INSERT INTO nstatistics_refer
        (ref_id, referal, DOMAIN, KEYWORD, COUNT, tstamp)
        VALUES
        (#{id}, #{referer}, #{domain}, #{keyword}, #{count}, #{created})
        <selectKey keyProperty="id" resultType="long" order="AFTER">
            SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>
    
    <update id="update" parameterType="StatisticRefererDomain" flushCache="true">
        UPDATE nstatistics_refer
        SET count = count + 1
        WHERE ref_id = #{id}
    </update>
    
</mapper>